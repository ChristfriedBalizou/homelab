---
- name: Install and configure NFS on master node
  block:
    - name: Install required packages
      ansible.builtin.apt:
        name: "nfs-kernel-server"
        state: present
        update_cache: true

    - name: Mount device from fstab
      ansible.posix.mount:
        path: "{{ item.mount }}"
        src: "{{ item.device }}"
        fstype: "{{ item.fstype }}"
        state: present
      loop: "{{ nfs_devices }}"

    - name: Configure NFS server
      ansible.builtin.lineinfile:
        regexp: "^/mnt/nfs"
        path: /etc/exports
        state: present
        line: "/mnt/nfs *(rw,all_squash,insecure,async,no_subtree_check,anonuid=1000,anongid=1000)"

    - name: Start nfs-kernel-server
      ansible.builtin.systemd:
        name: nfs-kernel-server.service
        enabled: true
        state: started
      failed_when: false

    - name: Create applications config folders
      ansible.builtin.file:
        path: "{{ media.applications.mount }}/{{ item }}"
        state: directory
        mode: '0766'
      loop: "{{ media.applications.folders }}"

    - name: Create persistence folders
      ansible.builtin.file:
        path: "{{ media.persistence.mount }}/{{ item }}"
        state: directory
        mode: '0766'
      loop: "{{ media.persistence.folders }}"
  when:
    - k3s_control_node is defined
    - k3s_control_node

- name: Mount NFS on workers fstab
  block:
    - name: Mount nfs device from fstab
      ansible.posix.mount:
        path: "/mnt/nfs"
        src: "{{ item.host }}:/mnt/nfs"
        fstype: "{{ item.fstype }}"
        opts: "rw"
        state: mounted
      loop: "{{ nfs_devices }}"
  when:
    - k3s_control_node is defined
    - k3s_control_node is false

- name: Configure and install admin monitors
  block:
    - name: Add Webmin source.list file
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        regexp: "^deb.*webmin.*"
        line: "deb http://download.webmin.com/download/repository sarge contrib"
        state: present

    - name: Add Webmin Apt signing key
      ansible.builtin.apt_key:
        url: http://www.webmin.com/jcameron-key.asc
        state: present

    - name: Install Webmin package
      ansible.builtin.apt:
        name: webmin
        state: present
        update_cache: true

    - name: Disable Webmin SSL
      ansible.builtin.lineinfile:
        path: /etc/webmin/miniserv.conf
        regexp: "^ssl=1"
        line: "ssl=0"
        backrefs: true

    - name: Refere webmin to node
      ansible.builtin.lineinfile:
        path: /etc/webmin/config
        line: "referers={{ inventory_hostname }}.{{ secret_domain }}"
        state: present

    - name: Enable Referers webmin
      ansible.builtin.lineinfile:
        path: /etc/webmin/config
        regexp: "^referers_none=1"
        line: "referers_none=0"
        backrefs: true

    - name: Restart Webmin service
      ansible.builtin.systemd:
        name: webmin.service
        state: restarted
        enabled: true
