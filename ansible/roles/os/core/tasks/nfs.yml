---
- name: Install and configure NFS on master node
  block:
    - name: Install required packages
      ansible.builtin.apt:
        name: "nfs-kernel-server"
        state: present
        update_cache: true

    - name: Check available device to mount
      ansible.builtin.command: lsblk {{ item.device }} -no UUID
      loop: "{{ nfs_devices }}"
      register: uuid

    - name: Format block device to ext4
      community.general.filesystem:
        fstype: "{{ item.item.fstype }}"
        dev: "{{ item.item.device }}"
      loop: "{{ uuid.results }}"

    - name: Check available device to mount
      ansible.builtin.command: lsblk {{ item.device }} -no UUID
      loop: "{{ nfs_devices }}"
      register: uuid

    - name: Mount device from fstab
      ansible.posix.mount:
        path: "{{ item.item.mount }}"
        src: "UUID={{ item.stdout_lines[0] }}"
        fstype: "{{ item.item.fstype }}"
        state: present
      when: item.stdout_lines
      loop: "{{ uuid.results }}"

    - name: Configure NFS server
      ansible.builtin.lineinfile:
        regexp: "^{{ item.item.mount }}"
        path: /etc/exports
        state: present
        line: "{{ item.item.mount }} *(rw,all_squash,insecure,async,no_subtree_check,anonuid=1000,anongid=1000)"
      when: item.stdout_lines
      loop: "{{ uuid.results }}"

    - name: Start nfs-kernel-server
      ansible.builtin.systemd:
        name: nfs-kernel-server.service
        enabled: true
        state: started
      failed_when: false
  when:
    - k3s_control_node is defined
    - k3s_control_node

- name: Mount NFS on workers fstab
  block:
    - name: Mount nfs device from fstab
      ansible.posix.mount:
        path: "{{ item.mount }}"
        src: "{{ item.host }}:{{ item.mount }}"
        fstype: "{{ item.fstype }}"
        opts: "rw"
        state: mounted
      loop: "{{ nfs_devices }}"
  when:
    - k3s_control_node is defined
    - k3s_control_node is false

- name: Configure and install admin monitors
  block:
    - name: Recursively change ownership of drive mount directory
      ansible.builtin.file:
        path: "{{ item.mount }}"
        state: directory
        recurse: true
        mode: "0766"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop: "{{ nfs_devices }}"

    - name: Add Webmin source.list file
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list
        regexp: "^deb.*webmin.*"
        line: "deb http://download.webmin.com/download/repository sarge contrib"
        state: present

    - name: Add Webmin Apt signing key
      ansible.builtin.apt_key:
        url: http://www.webmin.com/jcameron-key.asc
        state: present

    - name: Install Webmin package
      ansible.builtin.apt:
        name: webmin
        state: present
        update_cache: true

    - name: Disable Webmin SSL
      ansible.builtin.lineinfile:
        path: /etc/webmin/miniserv.conf
        regexp: "^ssl=1"
        line: "ssl=0"
        backrefs: true

    - name: Refere webmin to node
      ansible.builtin.lineinfile:
        path: /etc/webmin/config
        regexp: "^referers={{ ansible_host }}.*"
        line: "referers={{ ansible_host }}.{{ secret_domain }}"
        backrefs: true

    - name: Restart Webmin service
      ansible.builtin.service:
        name: webmin.service
        state: restarted
